name: Docker Image CI

on:
  push:
    branches: ["main"]
  pull_request:
    branches: ["main"]

jobs:
  Run-E2E-Tests:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v3
      - name: Check Docker Version
        run: docker --version
      - name: Copy env file
        run: cp .env.example .env
      - name: Build the Docker image
        run: docker-compose up --build -d
      - name: Test that the agent is running
        id: healthcheck
        run: |
          echo "health=$(curl -Is http://localhost:8100/health | head -n 1)" >> ${GITHUB_STATE}
      - name: Healthcheck
        if: "!contains(${{ steps.healthcheck.outputs.health }},204)"
        uses: actions/github-script@v3
        with:
          script: |
            echo "${{ steps.healthcheck.outputs.health }}"
            core.setFailed('Agent is not healthy')
      - name: Test basic query
        uses: ./.github/actions/test-action
        with:
          graphql-input: "{Airline(limit: 10){country}}"
          n1q1-input: 'SELECT country AS country FROM `travel-sample`.`inventory`.`airline` AS airline WHERE type = "airline" LIMIT 10'
